/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

package com.vg.hbase.manager.ui;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.apache.hadoop.hbase.client.Get;
import org.apache.hadoop.hbase.client.HTable;
import org.apache.hadoop.hbase.client.Result;
import org.apache.hadoop.hbase.util.Bytes;

import com.vg.hbase.comm.manager.HBaseTableManager;

/**
 * 
 * @author skrishnanunni
 */
public class JobManagerUtilityDialog extends javax.swing.JDialog {

	/**
	 * 
	 */
	private String selectedKeys = "";
	private HTable jobTable;

	private static final long serialVersionUID = -7989359567492234740L;
	private Map<String, JobInfo> jobData = new HashMap<String, JobInfo>();

	/**
	 * Creates new form JobManagerUtilityDialog
	 */
	public JobManagerUtilityDialog(java.awt.Frame parent, boolean modal, String selectedKeys) {

		super(parent, modal);
		this.selectedKeys = selectedKeys;
		jobTable = HBaseTableManager.getTable("Jobs");
		initComponents();

	}

	/**
	 * This method is called from within the constructor to initialize the form.
	 * WARNING: Do NOT modify this code. The content of this method is always
	 * regenerated by the Form Editor.
	 */
	@SuppressWarnings("unchecked")
	// <editor-fold defaultstate="collapsed"
	// desc="Generated Code">//GEN-BEGIN:initComponents
	private void initComponents() {

		jPanel1 = new javax.swing.JPanel();
		jLabel1 = new javax.swing.JLabel();
		comboJobIds = new javax.swing.JComboBox();
		jLabel2 = new javax.swing.JLabel();
		labelJobType = new javax.swing.JLabel();
		jLabel4 = new javax.swing.JLabel();
		labelJobStatus = new javax.swing.JLabel();
		jLabel6 = new javax.swing.JLabel();
		labelRetriesCount = new javax.swing.JLabel();
		jLabel8 = new javax.swing.JLabel();
		labelJobDate = new javax.swing.JLabel();
		jLabel10 = new javax.swing.JLabel();
		labelUserId = new javax.swing.JLabel();
		jPanel2 = new javax.swing.JPanel();
		jScrollPane1 = new javax.swing.JScrollPane();
		textJobXML = new javax.swing.JTextArea();
		clickUnlock = new javax.swing.JButton();
		clickRetry = new javax.swing.JButton();
		clickDelete = new javax.swing.JButton();
		clickExit = new javax.swing.JButton();
		clickUnlockAll = new javax.swing.JButton();

		setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
		setTitle("Collabrr Job Utilities");
		setAlwaysOnTop(true);

		jLabel1.setText("Job Ids:");

		comboJobIds.setModel(new javax.swing.DefaultComboBoxModel());
		comboJobIds.addActionListener(new java.awt.event.ActionListener() {
			public void actionPerformed(java.awt.event.ActionEvent evt) {

				comboJobIdsActionPerformed(evt);
			}
		});

		jLabel2.setText("Job Type: ");

		labelJobType.setText("<jtyp>");

		jLabel4.setText("Current Status: ");

		labelJobStatus.setText("<job status>");

		jLabel6.setText("Retries: ");

		labelRetriesCount.setText("<nums>");

		jLabel8.setText("Job Added at: ");

		labelJobDate.setText("<j info>");

		jLabel10.setText("User: ");

		labelUserId.setText("<user>");

		jPanel2.setBorder(javax.swing.BorderFactory.createTitledBorder("Job XML"));

		textJobXML.setColumns(20);
		textJobXML.setRows(5);
		textJobXML.setLineWrap(true);
		textJobXML.setWrapStyleWord(true);

		jScrollPane1.setViewportView(textJobXML);

		javax.swing.GroupLayout jPanel2Layout = new javax.swing.GroupLayout(jPanel2);
		jPanel2.setLayout(jPanel2Layout);
		jPanel2Layout.setHorizontalGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addComponent(jScrollPane1));
		jPanel2Layout.setVerticalGroup(jPanel2Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 251, Short.MAX_VALUE));

		clickUnlock.setText("Unlock");
		clickUnlock.addActionListener(new java.awt.event.ActionListener() {
			public void actionPerformed(java.awt.event.ActionEvent evt) {

				clickUnlockActionPerformed(evt);
			}
		});

		clickRetry.setText("Retry");
		clickRetry.addActionListener(new java.awt.event.ActionListener() {
			public void actionPerformed(java.awt.event.ActionEvent evt) {

				clickRetryActionPerformed(evt);
			}
		});

		clickDelete.setText("Delete");
		clickDelete.addActionListener(new java.awt.event.ActionListener() {
			public void actionPerformed(java.awt.event.ActionEvent evt) {

				clickDeleteActionPerformed(evt);
			}
		});

		clickExit.setText("Exit");
		clickExit.addActionListener(new java.awt.event.ActionListener() {
			public void actionPerformed(java.awt.event.ActionEvent evt) {

				clickExitActionPerformed(evt);
			}
		});

		clickUnlockAll.setText("Unlock All");
		clickUnlockAll.addActionListener(new java.awt.event.ActionListener() {
			public void actionPerformed(java.awt.event.ActionEvent evt) {

				clickUnlockAllActionPerformed(evt);
			}
		});

		javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
		jPanel1.setLayout(jPanel1Layout);
		jPanel1Layout.setHorizontalGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addComponent(jPanel2, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE).addGroup(jPanel1Layout.createSequentialGroup().addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addGroup(jPanel1Layout.createSequentialGroup().addContainerGap().addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addGroup(jPanel1Layout.createSequentialGroup().addComponent(jLabel1).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED).addComponent(comboJobIds, javax.swing.GroupLayout.PREFERRED_SIZE, 229, javax.swing.GroupLayout.PREFERRED_SIZE)).addGroup(jPanel1Layout.createSequentialGroup().addComponent(jLabel4).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED).addComponent(labelJobStatus)).addGroup(jPanel1Layout.createSequentialGroup().addComponent(jLabel8).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED).addComponent(labelJobDate))).addGap(18, 18, 18).addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addGroup(jPanel1Layout.createSequentialGroup().addComponent(jLabel10).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED).addComponent(labelUserId)).addGroup(jPanel1Layout.createSequentialGroup().addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addComponent(jLabel6).addComponent(jLabel2)).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED).addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addComponent(labelJobType).addComponent(labelRetriesCount))))).addGroup(jPanel1Layout.createSequentialGroup().addGap(70, 70, 70).addComponent(clickUnlockAll).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED).addComponent(clickUnlock).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED).addComponent(clickRetry).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED).addComponent(clickDelete).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED).addComponent(clickExit, javax.swing.GroupLayout.PREFERRED_SIZE, 68, javax.swing.GroupLayout.PREFERRED_SIZE))).addContainerGap(100, Short.MAX_VALUE)));
		jPanel1Layout.setVerticalGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addGroup(jPanel1Layout.createSequentialGroup().addGap(35, 35, 35).addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE).addComponent(jLabel1).addComponent(comboJobIds, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE).addComponent(jLabel2).addComponent(labelJobType)).addGap(34, 34, 34).addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE).addComponent(jLabel4).addComponent(labelJobStatus).addComponent(jLabel6).addComponent(labelRetriesCount)).addGap(40, 40, 40).addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE).addComponent(jLabel8).addComponent(labelJobDate).addComponent(jLabel10).addComponent(labelUserId)).addGap(71, 71, 71).addComponent(jPanel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE).addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED).addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE).addComponent(clickUnlock).addComponent(clickRetry).addComponent(clickDelete).addComponent(clickExit).addComponent(clickUnlockAll)).addContainerGap(29, Short.MAX_VALUE)));

		javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
		getContentPane().setLayout(layout);
		layout.setHorizontalGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE));
		layout.setVerticalGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING).addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE));

		pack();

		readJobInfo();

	}// </editor-fold>//GEN-END:initComponents

	private void readJobInfo() {

		List<Get> getList = new ArrayList<Get>();
		Result[] results;
		if (StringUtils.isNotEmpty(selectedKeys)) {
			String allJobs[] = selectedKeys.split(",");
			for (String jobId : allJobs) {

				Get g = new Get(Bytes.toBytes(jobId));
				getList.add(g);

			}

			try {
				results = jobTable.get(getList);

				for (Result result : results) {

					JobInfo jInfo = new JobInfo();
					jInfo.jobId = Bytes.toString(result.getRow());
					jInfo.jobDate = getvalue(result, "data", "cdt", true, false);
					jInfo.jobRetries = getvalue(result, "data", "rcnt", false, true);
					jInfo.jobType = getvalue(result, "data", "jtp", false, false);
					jInfo.jobStatus = getvalue(result, "data", "lck", false, false);
					jInfo.JobUser = getvalue(result, "data", "uid", false, false);
					jInfo.jobXML = getvalue(result, "content", "jxml", false, false);
					comboJobIds.addItem(jInfo.jobId);
					jobData.put(jInfo.jobId, jInfo);

				}
			}
			catch (Exception e) {
				e.printStackTrace();
			}

			if (jobData.size() > 0) {
				comboJobIdsActionPerformed(null);
			}
		}

	}

	private String getvalue(Result result, String family, String qualifier, boolean clong, boolean cshort) {

		String v = "";
		if (result != null && !result.isEmpty()) {

			byte[] value = result.getValue(Bytes.toBytes(family), Bytes.toBytes(qualifier));
			if (value != null) {
				if (clong)
					v = String.valueOf(Bytes.toLong(value));
				else if (cshort)
					v = String.valueOf(Bytes.toShort(value));
				else

					v = Bytes.toString(value);
			}

		}

		return v;

	}

	private void clickUnlockActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_clickUnlockActionPerformed

		// TODO add your handling code here:
	}// GEN-LAST:event_clickUnlockActionPerformed

	private void comboJobIdsActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_comboJobIdsActionPerformed

		String currentSelection = (String) comboJobIds.getSelectedItem();
		JobInfo jobInfo = jobData.get(currentSelection);

		if (jobInfo != null) {
			labelJobDate.setText(new Date(Long.parseLong(jobInfo.jobDate)).toString());
			if (jobInfo.jobStatus.equals("1"))
				labelJobStatus.setText("locked");
			else
				labelJobStatus.setText("un-locked");

			labelRetriesCount.setText(jobInfo.jobRetries);
			labelUserId.setText(jobInfo.JobUser);
			labelJobType.setText(jobInfo.jobType);
			textJobXML.setText(jobInfo.jobXML);

		}

	}// GEN-LAST:event_comboJobIdsActionPerformed

	private void clickUnlockAllActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_clickUnlockAllActionPerformed

		// TODO add your handling code here:
	}// GEN-LAST:event_clickUnlockAllActionPerformed

	private void clickRetryActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_clickRetryActionPerformed

		// TODO add your handling code here:
	}// GEN-LAST:event_clickRetryActionPerformed

	private void clickDeleteActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_clickDeleteActionPerformed

		// TODO add your handling code here:
	}// GEN-LAST:event_clickDeleteActionPerformed

	private void clickExitActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_clickExitActionPerformed

		this.dispose();
	}// GEN-LAST:event_clickExitActionPerformed

	/**
	 * @param args
	 *            the command line arguments
	 */
	public static void main(String args[]) {

		/*
		 * Set the Nimbus look and feel
		 */
		// <editor-fold defaultstate="collapsed"
		// desc=" Look and feel setting code (optional) ">
		/*
		 * If Nimbus (introduced in Java SE 6) is not available, stay with the
		 * default look and feel. For details see
		 * http://download.oracle.com/javase
		 * /tutorial/uiswing/lookandfeel/plaf.html
		 */
		try {
			for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
				if ("Nimbus".equals(info.getName())) {
					javax.swing.UIManager.setLookAndFeel(info.getClassName());
					break;
				}
			}

		}
		catch (ClassNotFoundException ex) {
			java.util.logging.Logger.getLogger(JobManagerUtilityDialog.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);

		}
		catch (InstantiationException ex) {
			java.util.logging.Logger.getLogger(JobManagerUtilityDialog.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);

		}
		catch (IllegalAccessException ex) {
			java.util.logging.Logger.getLogger(JobManagerUtilityDialog.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);

		}
		catch (javax.swing.UnsupportedLookAndFeelException ex) {
			java.util.logging.Logger.getLogger(JobManagerUtilityDialog.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
		}
		// </editor-fold>

		/*
		 * Create and display the dialog
		 */
		java.awt.EventQueue.invokeLater(new Runnable() {

			public void run() {

				JobManagerUtilityDialog dialog = new JobManagerUtilityDialog(new javax.swing.JFrame(), true, null);
				dialog.addWindowListener(new java.awt.event.WindowAdapter() {

					@Override
					public void windowClosing(java.awt.event.WindowEvent e) {

						System.exit(0);
					}
				});
				dialog.setVisible(true);
			}
		});
	}

	// Variables declaration - do not modify//GEN-BEGIN:variables
	private javax.swing.JButton clickDelete;
	private javax.swing.JButton clickExit;
	private javax.swing.JButton clickRetry;
	private javax.swing.JButton clickUnlock;
	private javax.swing.JButton clickUnlockAll;
	private javax.swing.JComboBox comboJobIds;
	private javax.swing.JLabel jLabel1;
	private javax.swing.JLabel jLabel10;
	private javax.swing.JLabel jLabel2;
	private javax.swing.JLabel jLabel4;
	private javax.swing.JLabel jLabel6;
	private javax.swing.JLabel jLabel8;
	private javax.swing.JPanel jPanel1;
	private javax.swing.JPanel jPanel2;
	private javax.swing.JScrollPane jScrollPane1;
	private javax.swing.JLabel labelJobDate;
	private javax.swing.JLabel labelJobStatus;
	private javax.swing.JLabel labelJobType;
	private javax.swing.JLabel labelRetriesCount;
	private javax.swing.JLabel labelUserId;
	private javax.swing.JTextArea textJobXML;
	// End of variables declaration//GEN-END:variables
}


class JobInfo {

	String jobType;
	String jobId;
	String jobDate;
	String jobRetries;
	String JobUser;
	String jobStatus;
	String jobXML;

}
